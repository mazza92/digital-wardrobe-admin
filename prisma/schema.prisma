// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Outfit {
  id            String   @id @default(cuid())
  title         String
  titleEn       String?   // English translation of title
  description   String?
  descriptionEn String?   // English translation of description
  imageUrl      String
  category      String   @default("outfit") // "outfit" or "wishlist"
  isPublished   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  products    Product[]
  analytics   OutfitAnalytics[]
  
  // Performance indexes for common queries
  @@index([isPublished, createdAt(sort: Desc)]) // For export query
  @@index([category])                           // For category filtering
  @@index([createdAt(sort: Desc)])              // For sorting
  @@map("outfits")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  brand       String
  price       String?
  imageUrl    String?
  affiliateLink String?
  x           Float
  y           Float
  outfitId    String
  
  outfit      Outfit   @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  analytics   ProductAnalytics[]
  favoritesAnalytics FavoritesAnalytics[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Performance indexes
  @@index([outfitId])               // Foreign key lookup
  @@index([brand])                  // Brand filtering
  @@index([outfitId, createdAt])    // Outfit products sorted by date
  @@map("products")
}

model OutfitAnalytics {
  id        String   @id @default(cuid())
  outfitId  String
  clicks    Int      @default(0)
  revenue   Float    @default(0)
  date      DateTime @default(now())
  
  outfit    Outfit   @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  
  @@map("outfit_analytics")
}

model ProductAnalytics {
  id        String   @id @default(cuid())
  productId String
  clicks    Int      @default(0)
  revenue   Float    @default(0)
  date      DateTime @default(now())
  
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@map("product_analytics")
}

model FavoritesAnalytics {
  id          String   @id @default(cuid())
  productId   String
  favorites   Int      @default(0)
  unfavorites Int      @default(0)
  date        DateTime @default(now())
  
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@map("favorites_analytics")
}

model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  logoUrl     String?
  affiliateApi String? // Which affiliate API to use (LTK, Affilae, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("brands")
}

model Profile {
  id          String   @id @default(cuid())
  name        String
  brand       String
  bio         String
  heroImage   String
  socialMedia Json?    // Store social media links as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("profiles")
}

// ============================================
// E-COMMERCE MODELS
// ============================================

model ShopProduct {
  id              String   @id @default(cuid())
  name            String
  nameEn          String?  // English translation
  description     String?
  descriptionEn   String?  // English translation
  price           Float    // Price in EUR (cents stored as float for simplicity)
  compareAtPrice  Float?   // Original price for showing discounts
  imageUrl        String
  images          String[] // Additional product images
  category        String   @default("accessory") // accessory, clothing, jewelry, etc.
  sku             String?  @unique // Stock Keeping Unit
  stock           Int      @default(0)
  lowStockAlert   Int      @default(5) // Alert when stock falls below this
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false)
  stripeProductId String?  // Stripe product ID
  stripePriceId   String?  // Stripe price ID
  weight          Float?   // Weight in grams (for shipping)
  
  orderItems      OrderItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([isActive, isFeatured])
  @@index([category])
  @@index([stock])
  @@map("shop_products")
}

model Order {
  id                String      @id @default(cuid())
  orderNumber       String      @unique // Human-readable order number (e.g., EK-2024-0001)
  status            OrderStatus @default(PENDING)
  
  // Customer info (can be guest or authenticated)
  customerId        String?     // Supabase user ID if authenticated
  customerEmail     String
  customerName      String
  
  // Shipping address
  shippingAddress   Json        // { line1, line2, city, postalCode, country, phone }
  
  // Pricing
  subtotal          Float       // Sum of items
  shippingCost      Float       @default(0)
  taxAmount         Float       @default(0)
  discount          Float       @default(0)
  total             Float       // Final total
  
  // Payment
  stripeSessionId   String?     // Stripe checkout session ID
  stripePaymentId   String?     // Stripe payment intent ID
  paymentMethod     String?     // card, paypal, etc.
  paidAt            DateTime?
  
  // Fulfillment
  trackingNumber    String?
  trackingUrl       String?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  
  // Notes
  customerNote      String?
  internalNote      String?
  
  items             OrderItem[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([customerId])
  @@index([customerEmail])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id          String      @id @default(cuid())
  orderId     String
  productId   String
  
  // Snapshot of product at time of order (in case product changes)
  productName String
  productSku  String?
  unitPrice   Float
  quantity    Int
  total       Float       // unitPrice * quantity
  
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     ShopProduct @relation(fields: [productId], references: [id])
  
  createdAt   DateTime    @default(now())
  
  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

enum OrderStatus {
  PENDING           // Order created, awaiting payment
  PAID              // Payment received
  PROCESSING        // Being prepared for shipping
  SHIPPED           // Shipped, tracking available
  DELIVERED         // Delivered to customer
  CANCELLED         // Order cancelled
  REFUNDED          // Payment refunded
}